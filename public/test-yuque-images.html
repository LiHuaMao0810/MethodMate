<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语雀图片渲染测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .latex-formula,
        .latex-formula-inline {
            display: inline-block;
            margin: 0 2px;
            vertical-align: middle;
            max-height: 1.5em;
            border: none;
            background: transparent;
        }
        .latex-formula-display {
            display: block;
            margin: 0.75rem auto;
            text-align: center;
            max-height: 10em;
            max-width: 100%;
            height: auto;
            border: none;
            background: transparent;
            padding: 0.25rem 0;
        }
        .latex-formula-display:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            background: rgba(249, 250, 251, 0.8);
            padding: 0.5rem;
            transition: all 0.2s ease;
        }
        .proxy-url {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
            font-weight: bold;
        }
        .success { background: #c8e6c9; color: #2e7d32; }
        .error { background: #ffcdd2; color: #c62828; }
    </style>
</head>
<body>
    <h1>语雀图片渲染测试</h1>
    
    <div class="test-section">
        <h2>1. 直接访问语雀LaTeX图片（预期失败）</h2>
        <p>测试URL: <code>https://cdn.nlark.com/yuque/__latex/97175e519d61d550ce1d0327b2f7999f.svg</code></p>
        <p>LaTeX公式：<img src="https://cdn.nlark.com/yuque/__latex/97175e519d61d550ce1d0327b2f7999f.svg" 
           class="latex-formula" 
           alt="LaTeX公式" 
           onload="document.getElementById('direct-status').className='status success'; document.getElementById('direct-status').textContent='✅ 直接访问成功';"
           onerror="document.getElementById('direct-status').className='status error'; document.getElementById('direct-status').textContent='❌ 直接访问失败（预期结果）';">
        </p>
        <div id="direct-status" class="status">加载中...</div>
    </div>

    <div class="test-section">
        <h2>2. 通过代理访问语雀LaTeX图片（预期成功）</h2>
        <div class="proxy-url">代理URL: /api/proxy-image?url=https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F__latex%2F97175e519d61d550ce1d0327b2f7999f.svg</div>
        <p>LaTeX公式：<img src="/api/proxy-image?url=https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F__latex%2F97175e519d61d550ce1d0327b2f7999f.svg" 
           class="latex-formula" 
           alt="LaTeX公式" 
           onload="document.getElementById('proxy-status').className='status success'; document.getElementById('proxy-status').textContent='✅ 代理访问成功';"
           onerror="document.getElementById('proxy-status').className='status error'; document.getElementById('proxy-status').textContent='❌ 代理访问失败';">
        </p>
        <div id="proxy-status" class="status">加载中...</div>
    </div>

    <div class="test-section">
        <h2>3. 测试no-referrer策略</h2>
        <p>LaTeX公式：<img src="https://cdn.nlark.com/yuque/__latex/97175e519d61d550ce1d0327b2f7999f.svg" 
           class="latex-formula" 
           alt="LaTeX公式" 
           referrerpolicy="no-referrer"
           onload="document.getElementById('noreferrer-status').className='status success'; document.getElementById('noreferrer-status').textContent='✅ no-referrer策略成功';"
           onerror="document.getElementById('noreferrer-status').className='status error'; document.getElementById('noreferrer-status').textContent='❌ no-referrer策略失败';">
        </p>
        <div id="noreferrer-status" class="status">加载中...</div>
    </div>

    <div class="test-section">
        <h2>4. 行内公式 vs 行间公式测试</h2>
        <h3>行内公式（小尺寸，与文本在同一行）</h3>
        <p>这是文本中的行内公式：<img src="/api/proxy-image?url=https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F__latex%2F97175e519d61d550ce1d0327b2f7999f.svg" 
           class="latex-formula-inline" 
           alt="x^2" 
           title="行内公式示例">，后面继续文本内容。</p>
           
        <h3>行间公式（大尺寸，独立成行）</h3>
        <p>下面是一个行间公式：</p>
        <img src="/api/proxy-image?url=https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F__latex%2Fdisplaystyle_example_123.svg" 
             class="latex-formula-display" 
             alt="displaystyle formula" 
             title="行间公式示例">
        <p>公式上方的内容。</p>

        <h3>自动检测测试</h3>
        <p>包含displaystyle的公式：<img src="/api/proxy-image?url=https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F__latex%2Fdisplaystyle_auto_detect.svg" 
           id="auto-display1" 
           alt="自动检测行间公式"></p>
        <p>普通小公式：<img src="/api/proxy-image?url=https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F__latex%2Fsimple_formula.svg" 
           id="auto-inline1" 
           alt="自动检测行内公式"></p>
    </div>

    <div class="test-section">
        <h2>5. Markdown渲染测试</h2>
        <div id="markdown-test"></div>
        <button onclick="testMarkdownRender()">测试Markdown渲染</button>
        <div id="markdown-status" class="status" style="display: none;">测试中...</div>
    </div>

    <script>
        // 自动检测LaTeX公式类型的函数
        function detectLatexType(src, alt) {
            const isDisplayMode = src.includes('displaystyle') || 
                                 src.includes('%5Cdisplaystyle') ||  // URL编码的\displaystyle
                                 src.includes('\\begin{') ||
                                 src.includes('%5Cbegin') ||  // URL编码的\begin
                                 src.includes('align') ||
                                 src.includes('equation') ||
                                 src.includes('$$') ||
                                 (alt && (alt.includes('$$') || alt.length > 50)); // 长公式通常是行间公式
            
            return isDisplayMode ? 'latex-formula-display' : 'latex-formula-inline';
        }

        function testMarkdownRender() {
            const testMarkdown = `行内公式测试：![img](https://cdn.nlark.com/yuque/__latex/inline_formula.svg) 和普通文本。

行间公式测试（包含displaystyle）：
![displaystyle formula](https://cdn.nlark.com/yuque/__latex/displaystyle_large_formula.svg)

另一个行间公式（包含begin环境）：
![equation environment](https://cdn.nlark.com/yuque/__latex/begin_equation_test.svg)

多个行内公式测试：![x](https://cdn.nlark.com/yuque/__latex/x.svg) + ![y](https://cdn.nlark.com/yuque/__latex/y.svg) = ![z](https://cdn.nlark.com/yuque/__latex/z.svg)`;

            // 模拟markdown渲染器的LaTeX公式自动检测
            const renderedHtml = testMarkdown.replace(
                /!\[([^\]]*)\]\(([^)]+)\)/g, 
                (match, alt, src) => {
                    if (src.includes('yuque/__latex')) {
                        const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(src)}`;
                        const className = detectLatexType(src, alt);
                        console.log(`LaTeX公式检测: ${className === 'latex-formula-display' ? '行间公式' : '行内公式'}`, src);
                        
                        return `<img src="${proxyUrl}" class="${className}" alt="${alt}" 
                                onload="console.log('✅ Markdown LaTeX图片加载成功:', '${proxyUrl}'); 
                                        if (this.naturalHeight > 40 && this.className === 'latex-formula-inline') { 
                                            this.className = 'latex-formula-display'; 
                                            console.log('🔄 根据实际尺寸调整为行间公式'); 
                                        }" 
                                onerror="console.error('❌ Markdown LaTeX图片加载失败:', '${proxyUrl}')">`;
                    }
                    return `<img src="${src}" alt="${alt}">`;
                }
            );

            document.getElementById('markdown-test').innerHTML = renderedHtml;
            document.getElementById('markdown-status').style.display = 'block';
            document.getElementById('markdown-status').className = 'status success';
            document.getElementById('markdown-status').textContent = '✅ Markdown渲染完成，请查看上方LaTeX公式的不同渲染效果';
        }

        // 自动检测测试中的公式类型
        function setupAutoDetection() {
            const autoDisplayImg = document.getElementById('auto-display1');
            const autoInlineImg = document.getElementById('auto-inline1');
            
            if (autoDisplayImg) {
                const displayClass = detectLatexType(autoDisplayImg.src, autoDisplayImg.alt);
                autoDisplayImg.className = displayClass;
                console.log('自动检测结果 - display1:', displayClass);
            }
            
            if (autoInlineImg) {
                const inlineClass = detectLatexType(autoInlineImg.src, autoInlineImg.alt);
                autoInlineImg.className = inlineClass;
                console.log('自动检测结果 - inline1:', inlineClass);
            }
        }

        // 页面加载完成后的状态检查
        window.addEventListener('load', () => {
            // 设置自动检测
            setupAutoDetection();
            
            setTimeout(() => {
                console.log('页面加载完成，检查图片状态...');
                
                // 检查各个测试的状态
                const statuses = ['direct-status', 'proxy-status', 'noreferrer-status'];
                statuses.forEach(id => {
                    const element = document.getElementById(id);
                    if (element.textContent === '加载中...') {
                        element.className = 'status error';
                        element.textContent = '❌ 加载超时';
                    }
                });
                
                console.log('🧪 LaTeX公式渲染测试页面加载完成');
                console.log('📏 行内公式应该显示较小，与文本对齐');
                console.log('📐 行间公式应该显示较大，独立成行');
            }, 5000); // 5秒后检查
        });
    </script>
</body>
</html> 