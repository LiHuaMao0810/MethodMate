# 对话历史结合功能优化说明

## 概述

本次优化主要解决了Coze在生成实验方案时忽略用户需求的问题。现在系统能够智能地从对话历史中提取用户的具体研究需求，并将这些需求与参考文献结合，生成更加个性化和针对性的研究方案。

## 主要优化内容

### 1. 新增对话历史分析功能

#### `extractConversationContext()` 函数
- **位置**: `src/views/ResearchPlanDetail.vue`
- **功能**: 从聊天历史中智能提取用户需求和研究上下文
- **提取内容**:
  - 研究主题和领域（包含"研究"、"实验"、"调查"等关键词）
  - 研究目标（包含"目标"、"目的"、"想要"等关键词）
  - 研究变量和指标（包含"变量"、"指标"、"测量"等关键词）
  - 研究方法和设计偏好（包含"方法"、"设计"、"问卷"等关键词）
  - 研究背景和上下文（包含"背景"、"现状"、"问题"等关键词）

### 2. 优化研究方案生成功能

#### `generateResearchPlan()` 函数优化
- **改进前**: 只考虑参考文献，忽略用户需求
- **改进后**: 
  1. 首先分析对话历史，提取用户需求
  2. 将用户需求与研究背景结合
  3. 根据是否有用户需求和参考文献，调整生成策略
  4. 在提示中明确要求优先考虑用户需求

#### 生成策略调整
```javascript
// 根据是否有用户需求和参考文献，调整生成策略
if (conversationContext.hasUserRequirements && referencedPapers.length > 0) {
  message += `，结合我提到的研究需求，生成一个详细的定量研究方案。`
} else if (conversationContext.hasUserRequirements) {
  message += `请基于我提到的研究需求，生成一个详细的定量研究方案。`
} else if (referencedPapers.length > 0) {
  message += `生成一个详细的定量研究方案。`
} else {
  message += `请生成一个详细的定量研究方案。`
}
```

### 3. 优化方案评估功能

#### `evaluatePlan()` 函数优化
- **新增评估维度**: 需求匹配度评估
- **评估内容**: 
  1. 方案是否充分考虑了用户的具体研究目标
  2. 研究假设是否与用户的需求高度匹配
  3. 实验设计是否适合用户的研究场景和偏好
  4. 数据分析方法是否能够有效回答用户的研究问题

### 4. 优化方案迭代功能

#### `iteratePlan()` 函数优化
- **改进前**: 只基于评估结果进行迭代
- **改进后**: 
  1. 结合评估结果和用户需求进行综合优化
  2. 确保优化后的方案更好地满足用户的具体研究需求
  3. 在保持科学严谨性的同时，优先考虑用户提到的研究目标和偏好

### 5. 优化来源介绍生成功能

#### `generateSourceIntroduction()` 函数优化
- **改进前**: 只分析参考文献与方案的关系
- **改进后**: 
  1. 结合用户需求分析文献选择
  2. 说明如何结合用户的具体研究需求来选择和调整方法要素
  3. 生成更个性化的来源介绍

### 6. 优化方法介绍生成功能

#### `generateMethodIntroduction()` 函数优化
- **新增内容**:
  1. 这些分析方法如何有效回答用户的具体研究问题
  2. 方法选择如何体现对用户研究需求的考虑

## 技术实现细节

### 对话历史分析算法

```javascript
// 分析最近的用户消息（最多取最近10条）
const recentUserMessages = userMessages.slice(-10)

for (const msg of recentUserMessages) {
  const content = msg.content.toLowerCase()
  
  // 提取研究主题和领域
  if (content.includes('研究') || content.includes('实验') || content.includes('调查')) {
    const sentences = msg.content.split(/[。！？\n]/).filter(s => 
      s.includes('研究') || s.includes('实验') || s.includes('调查') || 
      s.includes('分析') || s.includes('评估') || s.includes('测试')
    )
    userRequirements.push(...sentences)
  }
  
  // ... 其他提取逻辑
}
```

### 需求提取关键词

| 需求类型 | 关键词 |
|---------|--------|
| 研究主题和领域 | 研究、实验、调查、分析、评估、测试 |
| 研究目标 | 目标、目的、想要、希望、需要 |
| 研究变量和指标 | 变量、指标、测量、因素、影响、关系 |
| 研究方法和设计偏好 | 方法、设计、问卷、访谈、观察、实验 |
| 研究背景和上下文 | 背景、现状、问题、领域、行业、应用 |

## 测试功能

### 测试页面
- **位置**: `public/test-conversation-context.html`
- **功能**: 测试对话历史提取功能
- **使用方法**: 
  1. 在文本框中输入模拟的用户消息
  2. 点击"测试提取功能"按钮
  3. 查看提取结果

### 测试示例
```
我想研究用户界面设计对用户体验的影响
我的研究目标是了解不同界面设计元素如何影响用户的操作效率
我计划使用问卷调查和眼动追踪实验来收集数据
主要关注的因素包括界面布局、颜色搭配和交互反馈
我希望能够量化这些设计元素对用户满意度的影响
我的研究背景是在线教育平台，需要优化学习界面的用户体验
我想使用t检验和方差分析来比较不同设计方案的差异
我的研究问题是如何设计更符合用户认知习惯的界面
```

## 预期效果

### 1. 个性化方案生成
- 系统能够根据用户的具体需求生成定制化的研究方案
- 不再只是基于参考文献的通用方案

### 2. 需求匹配度评估
- 评估方案时增加需求匹配度维度
- 确保生成的方案真正满足用户的研究目标

### 3. 智能迭代优化
- 迭代时优先考虑用户偏好和研究场景
- 在科学严谨性和用户需求之间找到平衡

### 4. 个性化文档生成
- 来源介绍和方法说明更加贴合用户的研究背景
- 提供更有针对性的学术支持

## 使用建议

### 1. 用户交互建议
- 在聊天中明确表达研究目标和需求
- 提供具体的研究背景和场景信息
- 说明偏好的研究方法和设计思路

### 2. 系统使用流程
1. 在聊天框中与AI助手讨论研究需求
2. 选择相关的参考文献
3. 点击"生成定量研究方案"按钮
4. 系统会自动结合对话历史和参考文献生成个性化方案
5. 使用评估和迭代功能进一步优化方案

## 注意事项

1. **对话历史限制**: 系统只分析最近10条用户消息，建议在生成方案前确保关键需求在最近的对话中
2. **关键词识别**: 系统基于关键词识别需求，建议使用明确的研究术语
3. **需求优先级**: 当用户需求与参考文献冲突时，系统会优先考虑用户需求
4. **生成质量**: 个性化程度越高，生成时间可能越长

## 未来改进方向

1. **更智能的需求识别**: 使用NLP技术提高需求提取的准确性
2. **多轮对话理解**: 支持更复杂的多轮对话需求理解
3. **需求权重分析**: 根据对话频率和重要性给不同需求分配权重
4. **个性化推荐**: 基于用户历史偏好推荐研究方法和设计思路 