# 统计方法数据迁移功能说明

## 功能概述

这个功能将asset目录下的Markdown格式统计方法文档自动导入到数据库中，提升统计方法查询的效率和准确性。

## 功能特点

- ✅ **自动解析**：自动解析Markdown文件中的标题、内容和关键词
- ✅ **智能搜索**：支持精确匹配、模糊匹配、关键词匹配等多种搜索方式
- ✅ **全文搜索**：利用MySQL的全文索引功能（如果支持）
- ✅ **中英文兼容**：支持中英文统计术语的相互匹配
- ✅ **三级查询**：数据库 → 静态数据 → AI生成
- ✅ **关键词提取**：自动从文档中提取相关的统计学关键词

## 数据库表结构

```sql
CREATE TABLE statistical_methods (
  id INT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(255) NOT NULL,              -- 统计方法标题
  keywords TEXT,                            -- 关键词（逗号分隔）
  content LONGTEXT NOT NULL,                -- 完整的markdown内容
  file_source VARCHAR(255),                 -- 源文件名
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_title (title),
  FULLTEXT(title, keywords, content)        -- 全文索引
);
```

## 使用步骤

### 1. 准备Markdown文件

将统计方法的Markdown文件放置在 `asset/` 目录下，文件命名格式如：
- `1.md`
- `2.md` 
- `t检验.md`
- `方差分析.md`

### 2. 运行迁移脚本

在server目录下运行：

```bash
# 方式1：使用npm script
npm run migrate-methods

# 方式2：直接运行脚本
node run-migrate-statistical-methods.js

# 方式3：运行迁移模块
node migrate-statistical-methods.js
```

### 3. 验证迁移结果

脚本会输出详细的执行日志，包括：
- 找到的文件数量
- 每个文件的解析结果
- 导入成功/失败的统计
- 最终数据库中的记录总数

## API端点

### 1. 查询统计方法（原有接口，已增强）

```http
POST /api/query-statistical-method
Content-Type: application/json

{
  "method": "t检验"
}
```

**响应示例：**
```json
{
  "success": true,
  "method": "单样本t检验",
  "explanation": "详细的方法说明...",
  "keywords": "t检验, 单样本, 假设检验, 正态分布",
  "isLocalContent": true,
  "source": "数据库",
  "id": 1,
  "file_source": "1.md"
}
```

### 2. 获取所有统计方法列表（新增）

```http
GET /api/statistical-methods
```

**响应示例：**
```json
{
  "success": true,
  "methods": [
    {
      "id": 1,
      "title": "单样本t检验",
      "keywords": "t检验, 单样本, 假设检验",
      "file_source": "1.md",
      "created_at": "2024-01-01T00:00:00.000Z",
      "updated_at": "2024-01-01T00:00:00.000Z"
    }
  ],
  "total": 5
}
```

### 3. 根据ID获取统计方法详情（新增）

```http
GET /api/statistical-methods/{id}
```

## 搜索优先级

查询统计方法时，系统按以下优先级搜索：

1. **数据库精确匹配**：标题完全匹配
2. **数据库模糊匹配**：标题包含查询词
3. **数据库关键词匹配**：关键词中包含查询词
4. **数据库全文搜索**：使用MySQL全文索引
5. **数据库模糊变体匹配**：处理中英文术语对应、空格连字符等
6. **静态数据查询**：从 `statistical-methods-data.js` 查询
7. **AI生成**：调用Coze API生成

## 关键词提取策略

系统会自动从以下来源提取关键词：

- **标题解析**：提取标题中的核心词汇
- **统计术语**：识别常见的统计学术语
- **Markdown标题**：提取文档中的各级标题
- **中英文映射**：支持中英文术语的相互匹配

常见的统计术语包括：
- 检验、test、分析、analysis
- 方差、variance、回归、regression
- 相关、correlation、显著性、significance
- t检验、anova、卡方、wilcoxon等

## 故障排除

### 1. 数据库连接失败
确保数据库服务正在运行，且配置正确。

### 2. 文件读取失败
检查asset目录是否存在，且包含.md文件。

### 3. 权限问题
确保运行脚本的用户有读取asset目录和写入数据库的权限。

### 4. 全文索引不支持
某些MySQL版本或配置可能不支持全文索引，系统会自动降级使用其他搜索方式。

## 注意事项

1. **数据更新**：重新运行迁移脚本会清空现有的文件数据并重新导入
2. **编码格式**：确保Markdown文件使用UTF-8编码
3. **文件大小**：超大文件可能导致导入失败，建议单个文件不超过10MB
4. **关键词重复**：系统会自动去重关键词，无需担心重复

## 性能优化建议

1. **定期清理**：定期清理不再需要的统计方法记录
2. **索引维护**：保持数据库索引的更新
3. **缓存策略**：考虑在应用层添加查询缓存
4. **分批导入**：如果文件数量很大，可以考虑分批导入

---

更多问题请查看项目文档或联系开发团队。 