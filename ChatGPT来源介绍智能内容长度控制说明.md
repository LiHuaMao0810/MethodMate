# ChatGPT来源介绍智能内容长度控制说明

## 功能概述
为ChatGPT模式的生成来源介绍功能添加了智能内容长度控制机制，确保在最大消息长度限制下提供最优的参考文献内容。

## 实现逻辑

### 智能选择策略
当环境调试工具中选择ChatGPT服务时：

1. **全文优先策略**：除了研究方案内容，还尝试将参考文献全文整合到消息中
2. **长度检测**：检查消息总长度是否 <= 250,000字符  
3. **智能降级**：如果超过限制，自动切换为只包含研究方法提炼的版本

### 具体实现细节

#### 修改文件
- `src/views/ResearchPlanDetail.vue` - `generateSourceIntroduction` 函数

#### 关键代码逻辑

```javascript
// ChatGPT模式下的智能内容长度控制
if (currentAIService === 'chatgpt') {
  console.log('🎯 ChatGPT模式：生成来源介绍时检查消息长度，智能选择参考文献内容')
  
  // 先构建基础提示（不包含参考文献）
  let basePrompt = `我将为你提供一个研究方案，以及研究方案参考的一些参考文献。请分析以下研究方案的"${sectionName}"部分参考了哪些参考文献的研究方法内容，并生成一个简洁的来源介绍。

研究方案的${sectionName}部分：
${currentSectionContent}

参考文献信息：`
  
  // 尝试构建包含全文的版本
  let fullTextReferencesInfo = ''
  paperInfoArray.forEach((paperData) => {
    let enhancedPaperInfo = paperData.paperInfo
    
    // 如果有全文，添加到信息中
    if (paperData.fullText) {
      enhancedPaperInfo += `\n   全文内容：${paperData.fullText}`
    }
    
    fullTextReferencesInfo += enhancedPaperInfo
  })
  
  const fullTextPrompt = basePrompt + fullTextReferencesInfo
  
  // 检查包含全文的消息长度
  if (fullTextPrompt.length <= 250000) {
    console.log(`✅ 消息长度 ${fullTextPrompt.length} 字符，在限制内，使用全文版本`)
    referencesInfo = fullTextReferencesInfo
  } else {
    console.log(`⚠️ 消息长度 ${fullTextPrompt.length} 字符，超出限制，使用研究方法版本`)
    // 使用只包含研究方法的版本
    referencesInfo = paperInfoArray.map(paperData => paperData.paperInfo).join('')
  }
} else {
  console.log('🔧 Coze模式：使用标准参考文献处理')
  // Coze模式：使用原有逻辑，只包含研究方法和摘要
  referencesInfo = paperInfoArray.map(paperData => paperData.paperInfo).join('')
}
```

## 功能特点

### 1. 智能适应性
- **动态检测**：实时计算包含研究方案和参考文献的完整消息长度
- **自动切换**：无需用户手动选择，系统智能判断最佳内容策略
- **最优体验**：优先提供最丰富的分析依据，必要时自动降级

### 2. 服务区分
- **ChatGPT模式**：启用智能长度控制，优先使用全文+研究方案
- **Coze模式**：保持原有逻辑，专注于研究方法提炼
- **独立处理**：不同AI服务采用最适合的内容策略

### 3. 内容完整性
- **研究方案内容**：始终包含当前研究方案部分的完整内容
- **参考文献信息**：根据长度限制智能选择详细程度
- **上下文保持**：确保生成的来源介绍有充分的分析依据

## 内容策略对比

| 场景 | AI服务 | 消息长度 | 包含内容 | 说明 |
|------|--------|----------|----------|------|
| 理想情况 | ChatGPT | ≤ 250,000字符 | 研究方案 + 参考文献全文 | 最丰富的分析依据 |
| 长度限制 | ChatGPT | > 250,000字符 | 研究方案 + 研究方法提炼 | 确保API调用成功 |
| 标准模式 | Coze | 任意长度 | 研究方案 + 研究方法提炼 | 保持原有处理逻辑 |

## 技术优势

### 1. 分析质量提升
- **更丰富上下文**：ChatGPT可获得更完整的参考文献信息
- **精准来源分析**：基于全文内容能更准确识别方法来源
- **智能降级保障**：确保在任何情况下都能成功生成

### 2. 性能优化
- **避免截断**：防止内容被API强制截断
- **减少重试**：避免因内容过长导致的请求失败  
- **智能缓存**：复用已获取的论文内容和研究方法

### 3. 兼容性保障
- **向后兼容**：不影响现有Coze模式功能
- **平滑升级**：现有用户体验无变化
- **独立切换**：AI服务切换时自动适应

## 应用场景

### 1. 研究假设来源介绍
- 分析假设构建参考了哪些文献的理论基础
- 说明假设与参考文献观点的对应关系

### 2. 实验设计来源介绍  
- 识别实验设计借鉴的具体方法要素
- 说明设计方案与参考文献的方法论联系

### 3. 数据分析来源介绍
- 分析统计方法选择的文献依据
- 说明分析策略与参考研究的对应关系

### 4. 结果呈现来源介绍
- 识别结果展示形式的参考来源
- 说明呈现策略与文献实践的关联

## 日志说明

### ChatGPT模式日志
```
🎯 ChatGPT模式：生成来源介绍时检查消息长度，智能选择参考文献内容
✅ 消息长度 98765 字符，在限制内，使用全文版本
```

或

```
🎯 ChatGPT模式：生成来源介绍时检查消息长度，智能选择参考文献内容
⚠️ 消息长度 278945 字符，超出限制，使用研究方法版本
```

### Coze模式日志
```
🔧 Coze模式：使用标准参考文献处理
```

## 与研究方案生成的协同

本功能与之前实现的"ChatGPT研究方案智能内容长度控制"功能形成完整的系统：

1. **研究方案生成**：智能选择参考文献内容生成方案
2. **来源介绍生成**：智能选择参考文献内容分析来源

两个功能采用相同的长度控制策略，确保系统行为的一致性。

## 更新时间
2024年12月

## 技术负责人
系统开发团队 